---
layout: docs
title: Custom Host Action
---

== Custom Host Actions

{% include new_since.ad version="????" %}

Custom host actions can be added to the Host Actions menu on host detail pages.
This is done by creating a custom user template file called `user_host_commands.tt` in your user template path.

image:source/custom_host_action.png[Custom Host Action]

The template file will contain two parts:

1. The first part is used to add new host actions that post GET requests. It conforms to the existing format of host commands. The user can call them by clicking on a link.

2. The second part is used to add new host actions that post POST requests. For this a form with hidden fields are created and submitted with JavaScript upon clicking the link.

The form fields will be available as POST variables in the script called by the quick action. 

All variables are available as environment variables prefixed with `POST_`.

There is a script for printing them out in the stdout, which can be used for testing purposes: `print_post_variables.sh` in the Thruk script folder.
The template already includes an example that calls this script.

Additionally, there are two special variables containing the selected objects:

- `POST_SELECTED_SERVICES`: A list of all selected services.
- `POST_SELECTED_HOSTS`: A list of all selected hosts.

The format of the selected services is:
```
HOST;SERVICE;BACKEND~~HOST;SERVICE;BACKEND~~...
```

The format of the selected hosts is:
```
HOST;BACKEND~~HOST;BACKEND~~...
```

Even if the host actions are called from a host overview page with a single script, the selected_hosts variable will contain only that single host in the above format.
The selected_hosts variable will be empty in that case.

== Examples

=== Add a custom quick action

This custom host action will print all POST variables to stdout.

image:source/host_print_post_variables.png[Print POST variables]

If not already set, set the user template path in your `thruk_local.conf`:

.thruk_local.conf
-----
  user_template_path = ./my_templates
-----

Then create the file `user_host_commands.tt` in that directory and add the following content:

.my_templates/user_host_commands.tt
.....
{% raw %}
[%# This template is for custom host commands that the user specifies. #%]
[%# It will be put directly after the hardcoded host commands. It is evaluated all at once, does not need to be split into multiple blocks. #%]


[%# ========================= Templated GET Host Actions ========================= #%]

[%# The host commands pane already includes commands to be sent via GET to the CGI. #%]
[%# Take note to adapt to their style for custom actions. #%]

[%# Example GET command taken from template. It is disabled with IF 0 condition. #%]
[% IF 0 %]
    <div>
        [% IF host.accept_passive_checks %]
            <a class="js-modal-command-link" href="cmd.cgi?cmd_typ=93&amp;host=[% host.name | uri %]&amp;backend=[% host.peer_key %]">
                <i class="fa-solid fa-xmark round small red"></i>Stop accepting passive checks for this host
            </a>
        [% END %]
    </div>
[% END %]

[%# ========================= Templated POST Host Actions ========================= #%]

[%# These can put a form in the HTML for submitting POST requests to CGI. #%]
[%# These forms can have hidden inputs, and can be sent with the link via JS, behaving like the GET requests. #%]

[%# Example POST command. It is disabled with IF 0 condition. #%]
[% IF 0 %]
<div>
    <form id="host_print_post_variables_form" action="cmd.cgi" method="POST" onsubmit="">

        [%# These values here can be taken from the host object, which is in the scope where this template is included. #%]
        <input type='hidden' name='host' value="[% host.name | uri %]">
        <input type='hidden' name='backend' value="[% host.peer_key | html %]">

        [%# In the quick command menu, one can select multiple hosts. This builds a string called selected hosts. #%]
        [%# An example of this string looks like this: localhost;f4423~~testhost;f4424 #%]
        [%# In the host commands pane, we only have one host, so we do not need to join multiple hosts with '~~' #%]
        [%# We are also adding this field so that the scripts for the quick commands can be used as a reference for further processing. #%]
        <input type='hidden' name='selected_hosts' value="[% host.name | html %];[% host.peer_key | html %]">
        [%# Also define the other variable. In the host overview, there is no service to select. #%]
        <input type='hidden' name='selected_services' value="">

        [%# These values are taken from the template toolkit or other perl functions. #%]
        <input type='hidden' name='start_time' value="[% date.now %]">
        <input type='hidden' name='referer' value="[% short_uri(c, {referer => 'undef'}) %]">
        <input type="hidden" name="CSRFtoken" value="[% get_user_token(c) %]">

        [%# This is the command name that is defined in the Thruk configuration for this custom command #%]
        [%# It should be defined under action_menu_actions section in one of the thruk configuration files #%]
        [%# This example just calls the custom command 'print_post_variables'. #%]
        <input type='hidden' name='quick_command' value="server://print_post_variables">
    </form>
    <script>
        function submit_host_print_post_variables_form() {
            document.getElementById('host_print_post_variables_form').submit();
        }
    </script>
    <a class="js-modal-command-link" href="#" onclick="submit_host_print_post_variables_form(); return false;">
        <i class="fa-solid fa-terminal"></i>Print POST variables
    </a>
</div>
[% END %]
{% endraw %}
.....

Add an entry for the script called if someone uses the quick action.

.thruk_local.conf
-----
<action_menu_actions>
  print_post_variables = ./local/share/Thruk/script/print_post_variables.sh
</action_menu_actions>
-----

Finally the script `print_post_variables.sh` could look like this:

.print_post_variables.sh
++++++++++++++++++++++++
{% highlight bash %}
#!/bin/bash

# This script is intended to print details of a post request to the CGI.
# It should be invoked with a POST request to the CGI.
# This should be added as a custom service/host action to the Thruk.
# See the documentation for custom service/host actions more information.

echo "Showing fields of the POST request:"
env | grep 'POST_'

{% endhighlight %}
++++++++++++++++++++++++
